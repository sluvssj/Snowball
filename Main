-- Snowball Auto Parry [@dtbsnt]

if getgenv().executed then return end

local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local LocalPlayer = game:GetService("Players").LocalPlayer
local Balls = game:GetService("Workspace").Balls

local ballRangeDisplay = nil
local ballRange = 0

local closeClashes = 0

local canParry = true
local wasAttempted = false

local function notify(txt)
	game:GetService("StarterGui"):SetCore("SendNotification",{
       Title = "Snowball",
       Icon = string.format("rbxthumb://type=Asset&id=%s&w=420&h=420", "14968422803"),
       Text = txt,
       Duration = 2
    })
end

function FindBall()
    local RealBall

    for i, v in pairs(Balls:GetChildren()) do
        if v:GetAttribute("realBall") == true then
            RealBall = v
        end
    end
    return RealBall
end
function FindOtherBall()
    local OtherBall

    for i, v in pairs(Balls:GetChildren()) do
        if v:GetAttribute("realBall") ~= true then
            OtherBall = v
        end
    end
    return OtherBall
end

local Saved = {
	LastTick = os.clock();
	LastBallPosition = nil;
	LastPrediction = 0;
	LastTracer = nil;
	CurrentMethod = "Universal";
	inClash = false;
};

local function AttemptParry()
	ReplicatedStorage.Remotes.ParryButtonPress:Fire()
end

local function setup(Character)
	Character:WaitForChild("HumanoidRootPart")
	if ballRangeDisplay then ballRangeDisplay:Destroy() end
	ballRangeDisplay = Instance.new("Part")
	
	local didDie = false
	
	Character:WaitForChild("Humanoid").Died:Connect(function()
		didDie = true
	end)
	
	ballRangeDisplay.Material = Enum.Material.ForceField
	ballRangeDisplay.Transparency = 0.825
	ballRangeDisplay.CanCollide = false
	ballRangeDisplay.Size = Vector3.new(5,5,5)
	ballRangeDisplay.Color = Color3.fromRGB(255,255,255)
	ballRangeDisplay.Shape = Enum.PartType.Ball
	
	ballRangeDisplay.Parent = game:GetService("Workspace")
	local TBallRangeDisplay = ballRangeDisplay
	
	local function newSize(s)
		game:GetService("TweenService"):Create(TBallRangeDisplay, TweenInfo.new(0.75), {Size = Vector3.new(s, s, s)}):Play()
	end
	
	local ballIncomingSound = Instance.new("Sound")
	ballIncomingSound.SoundId = "rbxassetid://9113880610"
	ballIncomingSound.Parent = Character.HumanoidRootPart
	ballIncomingSound.Volume = 1.5
	
	ballIncomingSound:Play()
	
	Character.ChildRemoved:Connect(function(obj)
		if obj.Name == "Highlight" then
			canParry = true
		end
	end)
	RunService.RenderStepped:Connect(function()
		if Character:FindFirstChild("HumanoidRootPart") and Character:FindFirstChild("Head") and not didDie then
			local Ball = FindBall()
			local OtherBall = FindOtherBall()
			
			if Ball then
				if not Ball:FindFirstChild("PredictionValue") then
					tag = Instance.new("BillboardGui")
					tag.Parent = Ball
					tag.Size = UDim2.new(5,0,3,0)
					tag.ExtentsOffset = Vector3.new(0,3,0)
					label = Instance.new("TextLabel")
					label.Parent = tag
					label.Size = UDim2.new(1,0,1,0)
					label.BackgroundTransparency = 1
					label.TextScaled = true
					label.TextStrokeTransparency = 0
					label.TextColor3 = Color3.fromRGB(255, 255, 255)
					label.Text = "0"
					tag.Name = "PredictionValue"
					
					if not Character.Head:FindFirstChild("LogicUI") then
						logic_tag = Instance.new("BillboardGui")
						logic_tag.Parent = Character.Head
						logic_tag.Size = UDim2.new(15,0,3,0)
						logic_tag.ExtentsOffset = Vector3.new(0,2.25,0)
						new_label = Instance.new("TextLabel")
						new_label.Parent = logic_tag
						new_label.Size = UDim2.new(1,0,1,0)
						new_label.BackgroundTransparency = 1
						new_label.TextScaled = true
						new_label.TextStrokeTransparency = 0
						new_label.TextColor3 = Color3.fromRGB(255, 255, 255)
						new_label.Text = "0"
						logic_tag.Name = "LogicUI"
					end
					
					Saved.LastBallPosition = Ball.Position
					
					if Saved.LastTracer ~= nil then
						Saved.LastTracer:Destroy()
					end
					
					local Tracer = Drawing.new("Line")
					Tracer.Visible = false
					Tracer.Color = Color3.new(1, 1, 1)
					Tracer.Thickness = 1
					Tracer.Transparency = 1
					
					if Saved.LastTracer then
						Saved.LastTracer.Color = Color3.new(1, 1, 1)
					end
					
					Saved.LastTracer = Tracer
					
					Saved.inClash = false
					closeClashes = 0
					
					function line()
						game:GetService("RunService").RenderStepped:Connect(function()
							if Ball and Ball ~= nil then
								local Vector = game:GetService("Workspace").CurrentCamera:worldToViewportPoint(Ball.Position)
								
								Tracer.From = Vector2.new(game:GetService("Workspace").CurrentCamera.ViewportSize.X / 2, game:GetService("Workspace").CurrentCamera.ViewportSize.Y / 1.85)
								Tracer.To = Vector2.new(Vector.X, Vector.Y)
									
								Tracer.Visible = true
							else
								Tracer.Visible = false
							end
						end)
					end
					coroutine.wrap(line)()
				end
				
				local TCL = (#game:GetService("Workspace"):GetDescendants() / 1000) / 2.5
				local Delta = (os.clock() - Saved.LastTick) * 22.5
				if Delta > 1 then Delta = 1 end
				
				local Logic = math.abs(Ball.Position.Y - Saved.LastBallPosition.Y^1.5) / 100
				if Logic > 0.8725 then Logic = 0.8725 end
				
				if Character.Head:FindFirstChild("LogicUI") then
					Character.Head.LogicUI.TextLabel.Text = tostring(Logic)
				end
			
				local xVelocity = Ball.Velocity.X / Delta
				local yVelocity = Ball.Velocity.Y / Delta
				local zVelocity = Ball.Velocity.Z / Delta
				local totalVelocity = math.abs(math.sqrt(xVelocity^2 + yVelocity^2 + zVelocity^2)) / 10
				local realVelocity = Ball.Velocity.Magnitude
				if totalVelocity < 11.5 then totalVelocity = 11.25 end
				
				newSize(totalVelocity)
				TBallRangeDisplay.CFrame = Character:FindFirstChild("HumanoidRootPart").CFrame
				
				local PlayerPosition = Vector3.new(0, 0, 0)
				if LocalPlayer.Character:FindFirstChild("Head") then
					PlayerPosition = LocalPlayer.Character:FindFirstChild("Head").Position
				end
				
				local Distance
				if not OtherBall then
					Distance = (Ball.Position - PlayerPosition).Magnitude
					
					if Saved.CurrentMethod ~= "Focused" then
						Saved.CurrentMethod = "Focused"
						notify("New Method - Focused")
					end
				else
					Distance = (PlayerPosition - OtherBall.Position).Magnitude
					
					if Saved.CurrentMethod ~= "Universal" then
						Saved.CurrentMethod = "Universal"
						notify("New Method - Universal")
					end
				end
				
				if Character:FindFirstChild("Highlight") then	
	       			local PingAccountability = game.Stats.Network.ServerStatsItem["Data Ping"]:GetValue() / 950
	       			local IRL = (settings().Network.IncomingReplicationLag) + 0.0825
	       			local Prediction = ((totalVelocity + 15) + (PingAccountability * 20)) + IRL
	       			Prediction = ((Prediction * 1.325) + (TCL / 1.5)) / 1.117625
	       			Prediction -= Logic * 1.125
	       			
	       			newSize(Prediction)
	       			
	       			Ball.PredictionValue.TextLabel.Text = "%"..tostring(Prediction)
	       			
	       			Saved.LastTracer.Color = Color3.new(0.75, 0, 0)
	       				
	       			if Distance <= Prediction * 2 then if Distance <= Prediction * 1.125 then if not ballIncomingSound.IsPlaying then ballIncomingSound:Play() end end if canParry then Ball.PredictionValue.TextLabel.TextColor3 = Color3.fromRGB(235, 180, 45) end if Distance > Prediction * 1.25 then Ball.PredictionValue.TextLabel.TextColor3 = Color3.fromRGB(255, 255, 255) end end
	       			if Distance <= Prediction  / 1.075 or Saved.inClash then
	       				if realVelocity > 1.1725 then
	       					if canParry or Saved.inClash then
		       					Ball.PredictionValue.TextLabel.TextColor3 = Color3.fromRGB(145, 10, 10)
		       						
		       					if Distance < 30 then
		       						closeClashes += 1
		       						
		       						if closeClashes >= 5 then
		       							if not Saved.inClash then
		       								Saved.inClash = true
		       								
		       								notify("Entered Clash")
		       							end
		       						end
		       					else
		       						closeClashes = 0
		       						
		       						if Saved.inClash then
		       							Saved.inClash = false
		       							canParry = true
		       							
		       							notify("Clash Ended")
		       						end
		       					end
		       						
		       					AttemptParry()
		       					wasAttempted = false
			       				canParry = false
			       			else
			       				if Distance <= 25 then
			       					if Distance < 15 then
			       						canParry = true
			       						wasAttempted = true
			       						
			       						if realVelocity < 50 then
			       							closeClashes = 0
			       						end
			       					end
								end
		       				end
		       			else
		       				closeClashes = 0
	       				end
	       			else
	       				closeClashes = 0
	       			end
	       			
	       			Saved.LastBallPosition = Ball.Position
	       			Saved.LastPrediction = Prediction
	       		else
	       			if Distance <= Saved.LastPrediction * 1.5 then
	       				Ball.PredictionValue.TextLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	       			end
	       			
	       			Saved.LastTracer.Color = Color3.new(1, 1, 1)
	       			
       				Ball.PredictionValue.TextLabel.Text = "%"..tostring(totalVelocity)
				end
			else
				if Saved.LastTracer ~= nil then
					Saved.LastTracer:Destroy()
				end
			end
			
			Saved.LastTick = os.clock()
		end
	end)
end

getgenv().version = "1.0.1"
LocalPlayer.CharacterAdded:Connect(function(Character)
	setup(Character)
end)
setup(LocalPlayer.Character)

notify("Loaded, v"..getgenv().version.." | Mode - "..Saved.CurrentMethod)
getgenv().executed = true
